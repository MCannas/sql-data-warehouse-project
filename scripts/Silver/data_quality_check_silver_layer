--Loading and Quality Check of the Silver Table.
--Result: cleasing of the data before insert into the tables.

use master;
--GO;
USE DataWarehouse;
--GO;

--Loading the data after cleasing data from the bronze tables.

SELECT * FROM bronze.crm_prd_info

SELECT prd_id, count(*)
FROM bronze.crm_prd_info
GROUP BY prd_id
HAVING COUNT(*) > 1 OR prd_id IS NULL;


-- Extract the product key into different categories.
-- SUBSTRING()
-- Extracts a specific part of a string value.
-- First the cat_id from the first 5 characters.

SELECT prd_key, SUBSTRING(prd_key,1,5) AS cat_id
FROM bronze.crm_prd_info

SELECT prd_key, REPLACE(SUBSTRING(prd_key,1,5), '-', '_') AS cat_id
FROM bronze.crm_prd_info

-- Second check that the extracted bronze.crm_prd_info.cat_id equals the existing bronze.erp_px_cat_g1v2
-- Result: each row must match.
-- Check the value notation.
-- erp	   crm
-- CO_RF & CO-RF

-- Use a dynamic length extraction.
-- LEN()
-- Returns the number of characters in a string.

SELECT DISTINCT id FROM bronze.erp_px_cat_g1v2
WHERE id = 'CO_RF'

SELECT * FROM bronze.crm_sales_details

SELECT sls_prd_key FROM bronze.crm_sales_details

SELECT DISTINCT id 
FROM bronze.erp_px_cat_g1v2 t1, bronze.crm_prd_info t2
WHERE t1.ID = REPLACE(SUBSTRING(t2.prd_key,1,5), '-', '_')

-- Filters out unmatched data after applying transformation.

SELECT
	prd_id,
	prd_key,
	REPLACE(SUBSTRING(prd_key,1,5), '-', '_') AS cat_id,
	REPLACE(SUBSTRING(prd_key,7,LEN(prd_key)), '-', '_') AS prd_key,
	prd_nm,
	prd_cost,
	prd_line,
	prd_start_dt,
	prd_end_dt
FROM bronze.crm_prd_info
WHERE REPLACE(SUBSTRING(prd_key,1,5), '-', '_') NOT IN 
(SELECT DISTINCT id FROM bronze.erp_px_cat_g1v2)

-- Without a where-clause there are many without a product cost.
-- No results with the REPLACE command in the WHERE clause.
SELECT
	prd_id,
	prd_key,
	REPLACE(SUBSTRING(prd_key,1,5), '-', '_') AS cat_id,
	REPLACE(SUBSTRING(prd_key,7,LEN(prd_key)), '-', '_') AS prd_key,
	prd_nm,
	prd_cost,
	prd_line,
	prd_start_dt,
	prd_end_dt
FROM bronze.crm_prd_info
WHERE REPLACE(SUBSTRING(prd_key,7,LEN(prd_key)), '-', '_') NOT IN 
(SELECT sls_prd_key FROM bronze.crm_sales_details)


SELECT
	prd_id,
	prd_key,
	REPLACE(SUBSTRING(prd_key,1,5), '-', '_') AS cat_id,
	REPLACE(SUBSTRING(prd_key,7,LEN(prd_key)), '-', '_') AS prd_key,
	prd_nm,
	prd_cost,
	prd_line,
	prd_start_dt,
	prd_end_dt
FROM bronze.crm_prd_info
--WHERE REPLACE(SUBSTRING(prd_key,7,LEN(prd_key)), '-', '_') IN
--WHERE SUBSTRING(prd_key,7,LEN(prd_key)) IN 
--(SELECT sls_prd_key FROM bronze.crm_sales_details)


--Check for unwanted white spaces.
--TRIM command
--Result: no difference between the counts in the two queries.
--All row of the table are selected
SELECT
	COUNT(prd_nm)
FROM bronze.crm_prd_info

--Only the row with no differences in white spaces are selected.
SELECT
	COUNT(prd_nm)
FROM bronze.crm_prd_info
WHERE prd_nm = TRIM(prd_nm)

SELECT
	prd_id,
	prd_key,
	REPLACE(SUBSTRING(prd_key,1,5), '-', '_') AS cat_id,
	SUBSTRING(prd_key,7,LEN(prd_key)) AS prd_key,
	TRIM(prd_nm)
	prd_cost,
	prd_line,
	prd_start_dt,
	prd_end_dt
FROM bronze.crm_prd_info
--WHERE prd_nm = TRIM(prd_nm)


-- Check for NULLs or Negative Numbers.
-- Expectation: No Results
SELECT
	COUNT(prd_cost) AS product_cost
FROM bronze.crm_prd_info;

SELECT
	COUNT(prd_cost) AS product_cost
FROM bronze.crm_prd_info
WHERE prd_cost < 0;

SELECT
	COUNT(prd_cost) AS product_cost
FROM bronze.crm_prd_info
WHERE prd_cost IS NULL;

SELECT
	COUNT(prd_cost) AS product_cost
FROM bronze.crm_prd_info
WHERE prd_cost < 0 OR prd_cost IS NULL;

SELECT prd_cost AS product_cost
FROM bronze.crm_prd_info
WHERE prd_cost < 0 OR prd_cost IS NULL;

-- ISNULL()
-- Replaces NULL values with a specified replacement value.
-- You can use COALESCE as well

SELECT 
 ISNULL(prd_cost,0) AS prd_cost
FROM bronze.crm_prd_info
WHERE prd_cost < 0 OR prd_cost IS NULL;

SELECT
	prd_id,
	prd_key,
	REPLACE(SUBSTRING(prd_key,1,5), '-', '_') AS cat_id,
	SUBSTRING(prd_key,7,LEN(prd_key)) AS prd_key,
	TRIM(prd_nm),
	ISNULL(prd_cost,0) AS prd_cost,
	prd_line,
	prd_start_dt,
	prd_end_dt
FROM bronze.crm_prd_info


-- Data Standardization & Consistency
SELECT DISTINCT prd_line
FROM bronze.crm_prd_info


SELECT
	prd_line
	,CASE	WHEN UPPER(TRIM(prd_line)) = 'M' THEN 'Mountain' 
			WHEN UPPER(TRIM(prd_line)) = 'R' THEN 'Road'
			WHEN UPPER(TRIM(prd_line)) = 'S' THEN 'Other Sales'
			WHEN UPPER(TRIM(prd_line)) = 'T' THEN 'Touring'
	ELSE 'n/a'
	END AS prd_line
FROM bronze.crm_prd_info

--Quick CASE WHEN ideal for simple value mapping

SELECT
	prd_id,
	prd_key,
	REPLACE(SUBSTRING(prd_key,1,5), '-', '_') AS cat_id,
	SUBSTRING(prd_key,7,LEN(prd_key)) AS prd_key,
	TRIM(prd_nm),
	ISNULL(prd_cost,0) AS prd_cost,
	CASE UPPER(TRIM(prd_line))
		WHEN 'M' THEN 'Mountain' 
		WHEN 'R' THEN 'Road'
		WHEN 'S' THEN 'Other Sales'
		WHEN 'T' THEN 'Touring'
	ELSE 'n/a'
	END AS prd_line,
	prd_start_dt,
	prd_end_dt
FROM bronze.crm_prd_info

-- End date must not be earlier than the start date

-- Only select prd_start_dt
SELECT
prd_start_dt,
prd_end_dt
FROM bronze.crm_prd_info
WHERE 
	prd_start_dt IS NULL;

-- Only select prd_end_dt
SELECT
prd_start_dt,
prd_end_dt
FROM bronze.crm_prd_info
WHERE 
	prd_end_dt IS NULL;

-- Check for Invalid Date Orders
SELECT
prd_start_dt,
prd_end_dt
FROM bronze.crm_prd_info
WHERE 
	prd_end_dt < prd_start_dt;

-- For complex transformations in SQL, narrow it down to a 
-- specific example and brainstorm multiple solution approaches.


-- Switch End Date and Start Date
--End date must not be earlier than the start data.

--#1 Issue 
--Each Record must has a Start Date!
--This does not work because there are overlaps between records.

--#2 Solution 
--Derive the End Date from the Start Date.
--End Date = Start Date of the 'NEXT' Record - 1.
--LEAD() command to use to read a record within an exinting read.
--Access values from the next row wihtin a window.

SELECT
	prd_start_dt,
	prd_end_dt,
    LEAD(prd_start_dt) OVER (PARTITION BY prd_key ORDER BY prd_start_dt) - 1 AS prd_end_dt_test
FROM
    bronze.crm_prd_info
WHERE prd_key IN ('AC-HE-HL-U509-R', 'AC-HE-HL-U509');

-- prd_end_dt < prd_start_dt;



SELECT
prd_key,
prd_start_dt,
prd_end_dt
FROM bronze.crm_prd_info
WHERE
	prd_key LIKE '*HL*'; -- 'HL-U509-R';
--	AND	prd_end_dt < prd_start_dt;


--Complete code as so far 30 June 2025.
--Make the Data Time fields only Date with CAST command.
SELECT
	prd_id,
	prd_key,
	REPLACE(SUBSTRING(prd_key,1,5), '-', '_') AS cat_id,
	SUBSTRING(prd_key,7,LEN(prd_key)) AS prd_key,
	TRIM(prd_nm),
	ISNULL(prd_cost,0) AS prd_cost,
	CASE UPPER(TRIM(prd_line))
		WHEN 'M' THEN 'Mountain' 
		WHEN 'R' THEN 'Road'
		WHEN 'S' THEN 'Other Sales'
		WHEN 'T' THEN 'Touring'
	ELSE 'n/a'
	END AS prd_line,
	CAST (prd_start_dt AS DATE) AS prd_start_dt,
	CAST (LEAD(prd_start_dt) OVER (PARTITION BY prd_key ORDER BY prd_start_dt) - 1 AS DATE) AS prd_end_dt
FROM bronze.crm_prd_info

-- Add the needed fiels to process the data with the statement.
-- Modify the Silver table with the add of the cat_id field 'silver.crm_prd_info'.

INSERT INTO silver.crm_prd_info(
  prd_id,
  cat_id,
  prd_key,
  prd_nm,
  prd_cost,
  prd_line,
  prd_start_dt,
  prd_end_dt)
SELECT
	prd_id,
	REPLACE(SUBSTRING(prd_key,1,5), '-', '_') AS cat_id,
	SUBSTRING(prd_key,7,LEN(prd_key)) AS prd_key,
	TRIM(prd_nm),
	ISNULL(prd_cost,0) AS prd_cost,
	CASE UPPER(TRIM(prd_line))
		WHEN 'M' THEN 'Mountain' 
		WHEN 'R' THEN 'Road'
		WHEN 'S' THEN 'Other Sales'
		WHEN 'T' THEN 'Touring'
	ELSE 'n/a'
	END AS prd_line,
	CAST (prd_start_dt AS DATE) AS prd_start_dt,
	CAST (LEAD(prd_start_dt) OVER (PARTITION BY prd_key ORDER BY prd_start_dt) - 1 AS DATE) AS prd_end_dt
FROM bronze.crm_prd_info;

--Quality Check of the Loaded Data.

--Check for non unique product id's or missing.
--Expectation: No Results.
SELECT prd_id, count(*)
FROM silver.crm_prd_info
GROUP BY prd_id
HAVING COUNT(*) > 1 OR prd_id IS NULL;

--Check for white spaces.
--Expectation: No Results.
SELECT
	COUNT(prd_nm)
FROM bronze.crm_prd_info
WHERE prd_nm != TRIM(prd_nm);

--Check for NULLs or Negative Numbers.
--Expectation: No Results.
SELECT
	COUNT(prd_cost)
FROM silver.crm_prd_info
WHERE prd_cost < 0 OR prd_cost IS NULL;

SELECT prd_cost
FROM silver.crm_prd_info
WHERE prd_cost < 0 OR prd_cost IS NULL;

--Data Standardization & Consistency.
--Expectation: Complete Item Name and no NULLs.
SELECT DISTINCT prd_line
FROM silver.crm_prd_info

--Check for Invalid Date Orders
--Expectation: No Results.
SELECT
prd_start_dt,
prd_end_dt
FROM silver.crm_prd_info
WHERE 
	prd_end_dt < prd_start_dt;

--Check The Complete data in the Table
--Expectation: No Strange Data.
SELECT
*
FROM silver.crm_prd_info;
